<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PandaPanda AI - å°ˆæ¥­å·¥ä½œç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        panda: {
                            green: '#16a34a',
                            dark: '#14532d'
                        }
                    },
                    fontFamily: {
                        'tw-sans': ['system-ui', '-apple-system', "Microsoft JhengHei", 'sans-serif'],
                        'tw-serif': ["PMingLiU", "MingLiU", "serif"],
                        'tw-kaiti': ["BiaoKaiTi", "DFKai-SB", "KaiTi", "serif"],
                        'code': ['Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace']
                    },
                    zIndex: {
                        '60': '60',
                        '70': '70'
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* åŸºç¤è¨­å®š */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Markdown */
        .markdown-body { font-size: 16px; line-height: 1.7; }
        .markdown-body p { margin-bottom: 0.75em; }
        .markdown-body pre { 
            background-color: #1e1e1e; 
            color: #d4d4d4; 
            padding: 1rem; 
            border-radius: 0.5rem; 
            overflow-x: auto; 
            margin: 1em 0;
            position: relative;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
        }
        .markdown-body code { 
            background-color: rgba(0,0,0,0.05); 
            padding: 0.2em 0.4em; 
            border-radius: 0.25em; 
            font-family: inherit; 
        }
        .dark .markdown-body code:not(pre code) { background-color: rgba(255,255,255,0.1); }

        /* æ–‡ä»¶å¡ç‰‡ (èŠå¤©å®¤å…§é¡¯ç¤º) */
        .doc-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        .doc-card:hover {
            background: #f1f5f9;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark .doc-card {
            background: #1e293b;
            border-color: #334155;
        }
        .dark .doc-card:hover {
            background: #334155;
        }

        /* å½ˆå‡ºå¼æ–‡ä»¶ç´™å¼µ (Modal å…§é¡¯ç¤º) */
        .document-paper {
            background-color: #ffffff;
            width: 100%;
            max-width: 210mm; /* A4 */
            min-height: 297mm;
            margin: 2rem auto;
            padding: 25mm 20mm;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0,0,0,0.05);
            color: #000000; 
            font-size: 14pt;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        /* æ·±è‰²æ¨¡å¼ä¸‹ï¼Œæ–‡ä»¶ä¾ç„¶ä¿æŒç™½ç´™é»‘å­—ï¼Œä½†ç¨å¾®é™ä½äº®åº¦è­·çœ¼ */
        .dark .document-paper { filter: brightness(0.9); }

        /* å½ˆå‡ºè¦–çª—å‹•ç•« */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms ease-out, transform 200ms ease-out; }
        
        /* Loading */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Select Customization */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.2rem center;
            background-repeat: no-repeat;
            background-size: 1em 1em;
            padding-right: 1.5rem;
            appearance: none;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 h-screen flex flex-col font-tw-sans text-gray-800 dark:text-gray-100 transition-colors duration-300">

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm z-10 shrink-0">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="relative group cursor-pointer hover:scale-105 transition-transform">
                    <img src="https://lh3.googleusercontent.com/a/ACg8ocK0Sd79qNlGdQiGKEoKfuQxqHiVCHuyH4Sw5qFkJfpy4K_J23I=s288-c-no" class="w-9 h-9 rounded-full border-2 border-green-500 object-cover shadow-sm" onerror="this.src='https://api.iconify.design/noto:panda.svg';">
                </div>
                <h1 class="font-bold text-lg tracking-tight flex items-center gap-2">
                    PandaPanda AI
                    <span class="text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded-full dark:bg-green-900 dark:text-green-200">Workplace</span>
                </h1>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleTheme()" class="p-2 text-gray-500 hover:text-yellow-500 dark:text-gray-400 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-adjust"></i></button>
                <button onclick="openSettings()" class="p-2 text-gray-500 hover:text-green-600 dark:text-gray-400 dark:hover:text-green-400 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-cog"></i></button>
                <button onclick="clearChat()" class="p-2 text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 scroll-smooth bg-gray-100 dark:bg-gray-900">
        <div class="max-w-5xl mx-auto space-y-6 pb-4 min-h-[50vh]">
            <!-- Welcome -->
            <div id="welcome-message" class="flex gap-4 items-start fade-in">
                <img src="https://lh3.googleusercontent.com/a/ACg8ocK0Sd79qNlGdQiGKEoKfuQxqHiVCHuyH4Sw5qFkJfpy4K_J23I=s288-c-no" class="w-8 h-8 rounded-full border border-gray-200 dark:border-gray-600 flex-shrink-0" onerror="this.src='https://api.iconify.design/noto:panda.svg';">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-200 dark:border-gray-700 max-w-[85%]">
                    <p class="text-gray-700 dark:text-gray-200">
                        <span class="text-green-600 font-bold">å“ˆå›‰ï¼æˆ‘æ˜¯ PandaPanda AI ğŸ¼</span><br>
                        å·¥ä½œç«™å·²æ›´æ–°ï¼<br>
                        ğŸ“„ <span class="font-bold">æ–‡ä»¶åŠŸèƒ½</span>ï¼šç”Ÿæˆå¾Œå¯é»æ“Šã€Œæ‰“é–‹æ–‡ä»¶ã€åœ¨å½ˆçª—ä¸­é–±è®€ã€‚<br>
                        ğŸ’» <span class="font-bold">ç¨‹å¼åŠŸèƒ½</span>ï¼šé»æ“Šã€ŒåŸ·è¡Œé è¦½ã€æœƒåœ¨å½ˆçª—ä¸­åŸ·è¡Œç¨‹å¼ã€‚<br>
                        è«‹è¼¸å…¥ API Key ä¸¦é¸æ“‡å·¥å…·é–‹å§‹ï¼
                    </p>
                </div>
            </div>
            <div id="chat-history-container" class="space-y-6"></div>
        </div>
    </main>

    <!-- Footer Tools -->
    <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 shrink-0">
        <div class="max-w-4xl mx-auto">
            <div class="bg-gray-100 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-2xl p-2 focus-within:ring-2 focus-within:ring-green-500/50 focus-within:border-green-500 focus-within:bg-white dark:focus-within:bg-gray-800 transition-all shadow-sm">
                
                <div id="image-preview-area" class="hidden px-2 pt-2 pb-0 relative">
                    <img id="preview-img" class="h-16 w-auto rounded-lg border border-gray-300 dark:border-gray-600 object-cover">
                    <button onclick="clearImage()" class="absolute top-0 left-14 bg-gray-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-500">Ã—</button>
                </div>

                <textarea id="user-input" rows="1" placeholder="è¼¸å…¥å…§å®¹..." class="w-full bg-transparent border-none focus:ring-0 resize-none max-h-40 text-gray-700 dark:text-gray-100 px-3 py-2" oninput="autoResize(this)" onkeydown="handleKeyDown(event)"></textarea>

                <div class="flex items-center justify-between px-1 pt-1 mt-1 gap-2 flex-wrap">
                    <div class="flex items-center gap-2 flex-wrap">
                        <label class="cursor-pointer p-2 text-gray-400 hover:text-green-600 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full transition-colors">
                            <i class="fas fa-plus-circle text-lg"></i>
                            <input type="file" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
                        </label>
                        
                        <div class="relative group">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none text-gray-500"><i class="fas fa-toolbox text-xs"></i></div>
                            <select id="tool-select" onchange="updateModeOptions()" class="pl-7 pr-6 py-1.5 bg-gray-50 dark:bg-gray-600 border-none rounded-lg text-xs font-medium hover:bg-gray-200 dark:hover:bg-gray-500 cursor-pointer focus:ring-0 text-gray-700 dark:text-gray-200">
                                <option value="general">ğŸ¼ ä¸€èˆ¬èŠå¤©</option>
                                <option value="writing">âœï¸ å¯«ä½œæ–‡ä»¶</option>
                                <option value="coding">ğŸ’» å¯«ç¨‹å¼</option>
                                <option value="math">ğŸ§® æ•¸å­¸/ç†ç§‘</option>
                                <option value="research">ğŸ” æŸ¥è³‡æ–™</option>
                            </select>
                        </div>

                        <div class="relative group">
                            <select id="mode-select" class="pl-3 pr-6 py-1.5 bg-green-50 dark:bg-green-900/30 border-none rounded-lg text-xs font-medium text-green-700 dark:text-green-300 hover:bg-green-100 dark:hover:bg-green-900/50 cursor-pointer focus:ring-0 transition-colors"></select>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <select id="model-select" class="pr-6 py-1.5 bg-transparent border-none rounded-lg text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 cursor-pointer focus:ring-0 text-right">
                            <option value="flash">âš¡ Flash</option>
                            <option value="pro">ğŸ§  Pro</option>
                        </select>
                        <button id="send-btn" onclick="handleSend()" class="bg-green-600 hover:bg-green-700 text-white rounded-xl p-2 w-9 h-9 flex items-center justify-center shadow-sm disabled:opacity-50"><i class="fas fa-paper-plane text-sm"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- é è¦½å½ˆå‡ºè¦–çª— (é€šç”¨ï¼šæ–‡ä»¶/ç¨‹å¼ç¢¼) -->
    <div id="preview-modal" class="fixed inset-0 z-60 hidden">
        <!-- èƒŒæ™¯é®ç½© -->
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm transition-opacity" onclick="closePreviewModal()"></div>
        
        <!-- è¦–çª—å…§å®¹ -->
        <div class="absolute inset-4 md:inset-10 bg-gray-100 dark:bg-gray-900 rounded-xl shadow-2xl flex flex-col overflow-hidden transition-transform transform scale-95 opacity-0" id="preview-modal-content">
            
            <!-- é ‚éƒ¨å·¥å…·åˆ— -->
            <div class="bg-white dark:bg-gray-800 p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-2">
                    <span id="preview-title" class="font-bold text-lg text-gray-800 dark:text-white">é è¦½</span>
                    <span id="preview-type-badge" class="text-xs px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300">DOC</span>
                </div>
                <div class="flex items-center gap-2">
                    <!-- å¦‚æœæ˜¯æ–‡ä»¶ï¼Œé¡¯ç¤ºå­—é«”åˆ‡æ›æç¤º -->
                    <span id="preview-font-hint" class="text-xs text-gray-400 hidden md:inline-block">å¯åœ¨è¨­å®šæ›´æ”¹å­—é«”</span>
                    <button onclick="closePreviewModal()" class="bg-gray-200 hover:bg-red-500 hover:text-white text-gray-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-red-500 w-8 h-8 rounded-full flex items-center justify-center transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- å…§å®¹æ²å‹•å€ -->
            <div class="flex-1 overflow-auto p-4 md:p-8" id="preview-body">
                <!-- å‹•æ…‹æ³¨å…¥å…§å®¹ï¼šA4ç´™ æˆ– iframe -->
            </div>
        </div>
    </div>

    <!-- è¨­å®š Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-70 hidden flex items-center justify-center transition-opacity duration-200">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-transform scale-95 opacity-0" id="settings-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">è¨­å®š</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">API Key</label>
                    <input type="password" id="api-key-input" placeholder="Gemini API Key" class="w-full p-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ–‡ä»¶é¡¯ç¤ºå­—é«”</label>
                    <select id="font-family-select" class="w-full p-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white outline-none">
                        <option value="font-tw-kaiti">æ¨™æ¥·é«” (æ­£å¼)</option>
                        <option value="font-tw-sans">é»‘é«” (ç¾ä»£)</option>
                        <option value="font-tw-serif">å®‹é«” (æ–‡å­¸)</option>
                    </select>
                </div>
                <div class="flex gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="exportChat()" class="flex-1 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm">åŒ¯å‡º</button>
                    <label class="flex-1 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm text-center cursor-pointer">
                        åŒ¯å…¥ <input type="file" class="hidden" accept=".json" onchange="importChat(this)">
                    </label>
                </div>
                <button onclick="saveSettingsAndClose()" class="w-full bg-green-600 text-white font-medium py-2.5 rounded-lg">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="error-toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-2xl shadow-lg transition-all duration-300 opacity-0 pointer-events-none z-70 text-sm"></div>

    <script>
        // DOM Elements
        const CHAT_Container = document.getElementById('chat-history-container');
        const INPUT_Box = document.getElementById('user-input');
        const TOOL_Select = document.getElementById('tool-select');
        const MODE_Select = document.getElementById('mode-select');
        const MODEL_Select = document.getElementById('model-select');
        const API_KEY_Input = document.getElementById('api-key-input');
        const FONT_Select = document.getElementById('font-family-select');
        const SETTINGS_Modal = document.getElementById('settings-modal');
        const PREVIEW_Modal = document.getElementById('preview-modal');
        const PREVIEW_Body = document.getElementById('preview-body');
        
        let chatHistory = [];
        let currentImageBase64 = null;
        let userFontPreference = 'font-tw-kaiti';

        const TOOL_CONFIG = {
            'general': { label: 'ä¸€èˆ¬', modes: [{value:'chat', label:'ğŸ’¬ é–’èŠ'}, {value:'summarize', label:'ğŸ“ æ‘˜è¦'}] },
            'writing': { label: 'å¯«ä½œ', modes: [{value:'write_doc', label:'ğŸ“„ æ’°å¯«æ–‡ä»¶ (Word)'}, {value:'discuss', label:'ğŸ’¬ å¯«ä½œè¨è«–'}, {value:'guide', label:'ğŸ§­ å¯«ä½œæŒ‡å°'}] },
            'coding': { label: 'ç¨‹å¼', modes: [{value:'web_canvas', label:'ğŸŒ Web/Canvas'}, {value:'python', label:'ğŸ Python'}, {value:'general_code', label:'ğŸ’» ä¸€èˆ¬ç¨‹å¼'}] },
            'math': { label: 'æ•¸å­¸', modes: [{value:'solve', label:'ğŸ”¢ è§£é¡Œ'}, {value:'explain', label:'ğŸ“ è§€å¿µ'}] },
            'research': { label: 'ç ”ç©¶', modes: [{value:'search', label:'ğŸ” æŸ¥è³‡æ–™'}] }
        };

        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            updateModeOptions();
            renderChatUI();
        });

        function updateModeOptions() {
            const tool = TOOL_Select.value;
            const config = TOOL_CONFIG[tool];
            MODE_Select.innerHTML = '';
            config.modes.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.value;
                opt.textContent = m.label;
                MODE_Select.appendChild(opt);
            });
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                currentImageBase64 = e.target.result;
                document.getElementById('image-preview-area').classList.remove('hidden');
                document.getElementById('preview-img').src = currentImageBase64;
            };
            reader.readAsDataURL(file);
            input.value = '';
        }
        function clearImage() {
            currentImageBase64 = null;
            document.getElementById('image-preview-area').classList.add('hidden');
        }

        function getSystemPrompt(tool, mode) {
            let prompt = `ä½ ç¾åœ¨æ˜¯ PandaPanda AIã€‚
æœ€é«˜åŸå‰‡ï¼š
1. å¯«ä½œæ¨¡å¼(writing)ä¸‹ï¼Œåš´æ ¼ç¦æ­¢ä½¿ç”¨Markdownç²—é«”(**)å’Œåˆ†éš”ç·š(---)ã€‚
2. å¯«ç¨‹å¼æ™‚ï¼Œè«‹çµ¦å‡ºã€Œå®Œæ•´ç¨‹å¼ç¢¼ã€ï¼Œä¸å¯è·³éæˆ–çœç•¥ã€‚
3. å¯«ç¨‹å¼æ™‚ï¼Œé™¤éä½¿ç”¨è€…è¦æ±‚ä¿®æ”¹ï¼Œå¦å‰‡è«‹æ ¹æ“šéœ€æ±‚ç›´æ¥çµ¦å‡ºæœ€ä½³è§£ã€‚
4. åªèƒ½ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚
5. ä½ æ˜¯PandaPandaï¼Œä¸æ˜¯Geminiã€‚`;

            if (tool === 'writing' && mode === 'write_doc') {
                prompt += `\n[æ¨¡å¼ï¼šæ–‡ä»¶æ’°å¯«] è«‹ç”¢å‡ºåƒWordä¸€æ¨£çš„æ­£å¼æ–‡ä»¶ã€‚æ¨™é¡Œç›´æ¥å¯«å‡ºï¼Œä¸åŠ #ã€‚ä½¿ç”¨ç¸®æ’å’Œåœ‹å­—ç·¨è™Ÿ(ä¸€ã€äºŒã€1.)ã€‚`;
            } else if (tool === 'coding') {
                if (mode === 'web_canvas') {
                    prompt += `\n[æ¨¡å¼ï¼šWeb/Canvas] ä½¿ç”¨è€…æƒ³è¦ç¶²é æˆ–Canvasç‰¹æ•ˆã€‚
è«‹æä¾›ä¸€å€‹ã€Œå–®ä¸€ HTML æª”æ¡ˆã€ï¼ŒåŒ…å«æ‰€æœ‰ CSS å’Œ JSã€‚
å‹™å¿…åœ¨ HTML ä¸­ä½¿ç”¨ <canvas> æ¨™ç±¤ä¸¦ç”¨ JS ç¹ªåœ–ã€‚
ç¨‹å¼ç¢¼å¿…é ˆå®Œæ•´å¯åŸ·è¡Œã€‚`;
                } else {
                    prompt += `\n[æ¨¡å¼ï¼šå¯«ç¨‹å¼] è«‹æä¾›å®Œæ•´ã€å¯åŸ·è¡Œçš„ç¨‹å¼ç¢¼ã€‚`;
                }
            }
            return prompt;
        }

        function renderChatUI() {
            CHAT_Container.innerHTML = '';
            if (chatHistory.length === 0) document.getElementById('welcome-message').classList.remove('hidden');
            else document.getElementById('welcome-message').classList.add('hidden');

            chatHistory.forEach(msg => CHAT_Container.appendChild(createMessageElement(msg)));
            document.getElementById('chat-container').scrollTo({top: 99999, behavior: 'smooth'});
        }

        function createMessageElement(msg) {
            const isUser = msg.sender === 'user';
            const wrapper = document.createElement('div');
            wrapper.className = `flex gap-4 items-start ${isUser ? 'flex-row-reverse' : ''} fade-in`;

            const avatar = document.createElement('img');
            avatar.className = "w-8 h-8 rounded-full border border-gray-200 dark:border-gray-600 mt-1";
            avatar.src = isUser ? "https://api.iconify.design/carbon:user-avatar-filled.svg?color=%234b5563" : "https://lh3.googleusercontent.com/a/ACg8ocK0Sd79qNlGdQiGKEoKfuQxqHiVCHuyH4Sw5qFkJfpy4K_J23I=s288-c-no";
            if(!isUser) avatar.onerror = () => avatar.src='https://api.iconify.design/noto:panda.svg';

            // è¨Šæ¯å…§å®¹å®¹å™¨
            const contentDiv = document.createElement('div');
            
            // åˆ¤æ–·ï¼šæ˜¯å¦ç‚ºæ–‡ä»¶æ¨¡å¼
            if (!isUser && msg.tool === 'writing' && msg.mode === 'write_doc') {
                // æ–‡ä»¶æ¨¡å¼ï¼šé¡¯ç¤ºæ–‡ä»¶å¡ç‰‡ (é»æ“Šæ‰“é–‹å½ˆçª—)
                contentDiv.className = ""; // Reset default
                contentDiv.innerHTML = `
                    <div class="doc-card" onclick="openPreviewModal('doc', \`${encodeURIComponent(msg.text)}\`)">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-2xl shrink-0">
                            <i class="fas fa-file-word"></i>
                        </div>
                        <div>
                            <div class="font-bold text-gray-800 dark:text-gray-200">æ–‡ä»¶å·²ç”Ÿæˆ</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">é»æ“Šé–‹å•Ÿå…¨è¢å¹•é–±è®€æ¨¡å¼</div>
                        </div>
                        <i class="fas fa-external-link-alt text-gray-400 ml-auto"></i>
                    </div>
                `;
            } else {
                // ä¸€èˆ¬å°è©±æ¨¡å¼
                contentDiv.className = `p-4 rounded-2xl shadow-sm border max-w-[90%] md:max-w-[80%] overflow-hidden ${isUser ? 'bg-green-600 text-white rounded-tr-none' : 'bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 rounded-tl-none border-gray-200 dark:border-gray-700 markdown-body'}`;
                
                if (msg.image) {
                    const img = document.createElement('img');
                    img.src = msg.image;
                    img.className = "max-w-full h-auto rounded-lg mb-2 max-h-64 object-contain";
                    contentDiv.appendChild(img);
                }

                const textDiv = document.createElement('div');
                if (isUser) {
                    textDiv.innerText = msg.text;
                } else {
                    textDiv.innerHTML = marked.parse(msg.text);
                    if (msg.tool === 'coding' && msg.mode === 'web_canvas') {
                        injectCodePreviews(textDiv);
                    }
                }
                contentDiv.appendChild(textDiv);
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(contentDiv);
            return wrapper;
        }

        // --- é è¦½å½ˆå‡ºè¦–çª—é‚è¼¯ ---
        function openPreviewModal(type, content) {
            PREVIEW_Modal.classList.remove('hidden');
            const modalContent = document.getElementById('preview-modal-content');
            
            // Reset Content
            PREVIEW_Body.innerHTML = '';
            
            if (type === 'doc') {
                // æ–‡ä»¶æ¨¡å¼
                document.getElementById('preview-title').innerText = "æ–‡ä»¶æª¢è¦–";
                document.getElementById('preview-type-badge').innerText = "DOC";
                document.getElementById('preview-type-badge').className = "text-xs px-2 py-1 rounded bg-blue-100 text-blue-600";
                document.getElementById('preview-font-hint').classList.remove('hidden');

                const paper = document.createElement('div');
                paper.className = `document-paper shadow-lg ${userFontPreference}`; // å¥—ç”¨è¨­å®šå­—é«”
                paper.innerText = decodeURIComponent(content); // å¯«å…¥ç´”æ–‡å­—
                PREVIEW_Body.appendChild(paper);
                PREVIEW_Body.classList.remove('bg-gray-900'); // ç¢ºä¿èƒŒæ™¯é©åˆæ–‡ä»¶é–±è®€
                PREVIEW_Body.classList.add('bg-gray-100', 'dark:bg-gray-900');

            } else if (type === 'code') {
                // ç¨‹å¼ç¢¼é è¦½æ¨¡å¼
                document.getElementById('preview-title').innerText = "ç¨‹å¼åŸ·è¡Œé è¦½";
                document.getElementById('preview-type-badge').innerText = "RUN";
                document.getElementById('preview-type-badge').className = "text-xs px-2 py-1 rounded bg-green-100 text-green-600";
                document.getElementById('preview-font-hint').classList.add('hidden');

                const iframe = document.createElement('iframe');
                iframe.className = "w-full h-full bg-white border border-gray-200 rounded-lg";
                const blob = new Blob([decodeURIComponent(content)], {type: 'text/html'});
                iframe.src = URL.createObjectURL(blob);
                PREVIEW_Body.innerHTML = ''; // clear
                PREVIEW_Body.appendChild(iframe);
            }

            // å‹•ç•«é¡¯ç¤º
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closePreviewModal() {
            const modalContent = document.getElementById('preview-modal-content');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => PREVIEW_Modal.classList.add('hidden'), 200);
        }

        function injectCodePreviews(container) {
            const codeBlocks = container.querySelectorAll('pre code');
            codeBlocks.forEach(block => {
                if (block.className.includes('html') || block.className.includes('xml')) {
                    const code = block.innerText;
                    const pre = block.parentElement;
                    
                    const btn = document.createElement('button');
                    btn.className = "absolute top-2 right-2 bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded-full transition-colors shadow-sm z-10 flex items-center gap-1";
                    btn.innerHTML = '<i class="fas fa-play"></i> åŸ·è¡Œé è¦½';
                    // é»æ“Šå¾Œæ‰“é–‹å½ˆçª—
                    btn.onclick = () => openPreviewModal('code', encodeURIComponent(code));
                    
                    pre.style.position = 'relative';
                    pre.appendChild(btn);
                }
            });
        }

        // --- ç™¼é€ ---
        async function handleSend() {
            const apiKey = localStorage.getItem('panda_api_key');
            if (!apiKey) { openSettings(); return; }
            const text = INPUT_Box.value.trim();
            if (!text && !currentImageBase64) return;

            const tool = TOOL_Select.value;
            const mode = MODE_Select.value;
            const modelLevel = MODEL_Select.value;

            chatHistory.push({ sender: 'user', text: text, image: currentImageBase64 });
            renderChatUI();

            const imgToSend = currentImageBase64;
            clearImage();
            INPUT_Box.value = '';
            document.getElementById('send-btn').disabled = true;

            const loading = document.createElement('div');
            loading.id = 'loading-indicator';
            loading.innerHTML = `<div class="flex gap-4 items-start fade-in"><img src="https://lh3.googleusercontent.com/a/ACg8ocK0Sd79qNlGdQiGKEoKfuQxqHiVCHuyH4Sw5qFkJfpy4K_J23I=s288-c-no" class="w-8 h-8 rounded-full mt-1"><div class="bg-white dark:bg-gray-800 p-4 rounded-2xl rounded-tl-none shadow-sm"><div class="flex gap-1"><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div></div></div></div>`;
            CHAT_Container.appendChild(loading);
            document.getElementById('chat-container').scrollTo({top: 99999, behavior: 'smooth'});

            try {
                const contents = [
                    { role: "user", parts: [{ text: getSystemPrompt(tool, mode) }] },
                    { role: "model", parts: [{ text: "æ”¶åˆ°ï¼Œæˆ‘æ˜¯PandaPandaã€‚" }] },
                    ...chatHistory.slice(0, -1).map(m => ({ role: m.sender==='user'?'user':'model', parts: [{text: m.text}] }))
                ];

                const parts = [{ text: text }];
                if (imgToSend) {
                    parts.push({ inline_data: { mime_type: imgToSend.split(';')[0].split(':')[1], data: imgToSend.split(',')[1] } });
                }
                contents.push({ role: "user", parts: parts });

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contents,
                        generationConfig: { temperature: modelLevel==='pro'?0.7:0.9, maxOutputTokens: 8000 }
                    })
                });
                
                const data = await res.json();
                if(!res.ok) throw new Error(data.error?.message || "Error");
                
                const reply = data.candidates[0].content.parts[0].text;
                chatHistory.push({ sender: 'panda', text: reply, tool: tool, mode: mode });
                saveChatToLocal();
                renderChatUI();

            } catch (e) {
                chatHistory.pop();
                document.getElementById('error-toast').innerText = "éŒ¯èª¤: " + e.message;
                document.getElementById('error-toast').classList.remove('opacity-0', 'pointer-events-none');
                setTimeout(()=>document.getElementById('error-toast').classList.add('opacity-0'), 3000);
            } finally {
                if(document.getElementById('loading-indicator')) document.getElementById('loading-indicator').remove();
                document.getElementById('send-btn').disabled = false;
            }
        }

        // --- è¼”åŠ© ---
        function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,160)+'px'; }
        function handleKeyDown(e) { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }
        function openSettings() { SETTINGS_Modal.classList.remove('hidden'); setTimeout(()=>document.getElementById('settings-modal-content').classList.remove('scale-95','opacity-0'),10); }
        function closeSettings() { document.getElementById('settings-modal-content').classList.add('scale-95','opacity-0'); setTimeout(()=>SETTINGS_Modal.classList.add('hidden'),200); }
        
        function loadSettings() {
            API_KEY_Input.value = localStorage.getItem('panda_api_key')||'';
            userFontPreference = localStorage.getItem('panda_font_pref') || 'font-tw-kaiti';
            FONT_Select.value = userFontPreference;
            if(localStorage.getItem('panda_theme')==='dark') document.documentElement.classList.add('dark');
        }
        function saveSettingsAndClose() {
            localStorage.setItem('panda_api_key', API_KEY_Input.value);
            userFontPreference = FONT_Select.value;
            localStorage.setItem('panda_font_pref', userFontPreference);
            closeSettings();
            renderChatUI(); 
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('panda_theme', document.documentElement.classList.contains('dark')?'dark':'light');
        }
        
        function loadChatHistory() { try { chatHistory = JSON.parse(localStorage.getItem('panda_chat_history')) || []; } catch{ chatHistory=[]; } }
        function saveChatToLocal() { localStorage.setItem('panda_chat_history', JSON.stringify(chatHistory)); }
        function clearChat() { if(confirm('æ¸…é™¤ç´€éŒ„ï¼Ÿ')) { chatHistory=[]; saveChatToLocal(); renderChatUI(); } }
        function exportChat() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(chatHistory)],{type:'application/json'}));
            a.download = 'panda_chat.json';
            a.click();
        }
        function importChat(input) {
            const r = new FileReader();
            r.onload = e => { try{ chatHistory=JSON.parse(e.target.result); saveChatToLocal(); renderChatUI(); }catch{} };
            r.readAsText(input.files[0]);
        }
    </script>
</body>
</html>
